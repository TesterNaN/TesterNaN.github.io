<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸµ è™«è™«é’¢ç´CCMZè½¬MIDIåœ¨çº¿å·¥å…·</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #4361ee;
            --secondary-color: #3a0ca3;
            --success-color: #4cc9f0;
            --danger-color: #f72585;
            --warning-color: #f8961e;
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --border-radius: 12px;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: var(--dark-color);
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        h1 {
            color: var(--primary-color);
            font-size: 2.5rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        h1 i {
            color: var(--danger-color);
        }

        .subtitle {
            color: #666;
            font-size: 1.1rem;
            max-width: 800px;
            margin: 0 auto;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 30px;
            transition: var(--transition);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        }

        .card h2 {
            color: var(--secondary-color);
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card h2 i {
            color: var(--primary-color);
        }

        .input-group {
            margin-bottom: 25px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .input-group input,
        .input-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: var(--transition);
        }

        .input-group input:focus,
        .input-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
        }

        .button {
            display: inline-block;
            padding: 14px 28px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            text-align: center;
            width: 100%;
            margin-top: 10px;
        }

        .button:hover {
            background: var(--secondary-color);
            transform: translateY(-2px);
        }

        .button:active {
            transform: translateY(0);
        }

        .button.secondary {
            background: #6c757d;
        }

        .button.secondary:hover {
            background: #545b62;
        }

        .button.success {
            background: var(--success-color);
        }

        .button.success:hover {
            background: #2bb2d9;
        }

        .button.danger {
            background: var(--danger-color);
        }

        .button.danger:hover {
            background: #e11570;
        }

        .button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .file-input-container {
            position: relative;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .file-input-container input[type="file"] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-input-label {
            display: block;
            padding: 40px 20px;
            border: 3px dashed #ddd;
            border-radius: 8px;
            text-align: center;
            color: #666;
            transition: var(--transition);
            cursor: pointer;
        }

        .file-input-label:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        .file-input-label i {
            font-size: 3rem;
            margin-bottom: 15px;
            display: block;
        }

        .file-selected {
            border-color: var(--success-color);
            background-color: rgba(76, 201, 240, 0.05);
        }

        .status-box {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
        }

        .status-box h3 {
            margin-bottom: 15px;
            color: var(--secondary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-content {
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.9rem;
            line-height: 1.5;
            padding: 15px;
            background: white;
            border-radius: 5px;
            border: 1px solid #eee;
        }

        .log-entry {
            margin-bottom: 8px;
            padding: 5px 0;
            border-bottom: 1px dashed #f0f0f0;
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-success {
            color: #28a745;
        }

        .log-error {
            color: #dc3545;
        }

        .log-warning {
            color: #ffc107;
        }

        .log-info {
            color: #17a2b8;
        }

        .progress-container {
            margin-top: 20px;
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: #e9ecef;
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--success-color));
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            text-align: center;
            font-size: 0.9rem;
            color: #666;
        }

        .download-link {
            display: inline-block;
            padding: 12px 24px;
            background: var(--success-color);
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            transition: var(--transition);
            margin-top: 15px;
        }

        .download-link:hover {
            background: #2bb2d9;
            transform: translateY(-2px);
        }

        footer {
            text-align: center;
            margin-top: 50px;
            padding: 20px;
            color: #666;
            font-size: 0.9rem;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(67, 97, 238, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* æ ‡ç­¾é¡µæ ·å¼ */
        .tab-container {
            margin-bottom: 25px;
        }
        
        .tabs {
            display: flex;
            border-bottom: 2px solid #f0f0f0;
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            font-size: 1rem;
            cursor: pointer;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: var(--transition);
            flex: 1;
            text-align: center;
        }
        
        .tab:hover {
            color: var(--primary-color);
        }
        
        .tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            font-weight: 600;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-music"></i> CCMZ åˆ° MIDI è½¬æ¢å·¥å…·</h1>
            <p class="subtitle">åœ¨çº¿å°†è™«è™«é’¢ç´CCMZæ–‡ä»¶è½¬æ¢ä¸ºæ ‡å‡†MIDIæ ¼å¼ï¼Œæ— éœ€å®‰è£…ä»»ä½•è½¯ä»¶ï¼Œå®Œå…¨åœ¨æµè§ˆå™¨ä¸­è¿è¡Œ</p>
        </header>

        <div class="main-content">
            <!-- è¾“å…¥åŒºåŸŸ -->
            <div class="card">
                <h2><i class="fas fa-upload"></i> è¾“å…¥æº</h2>
                
                <div class="tab-container">
                    <div class="tabs">
                        <button class="tab active" data-tab="url-tab">URLä¸‹è½½</button>
                        <button class="tab" data-tab="file-tab">æœ¬åœ°æ–‡ä»¶</button>
                    </div>
                    
                    <div class="tab-content active" id="url-tab">
                        <div class="input-group">
                            <label for="url-input">CCMZæ–‡ä»¶URLåœ°å€</label>
                            <input type="text" id="url-input" placeholder="è¯·è¾“å…¥CCMZæ–‡ä»¶çš„URLåœ°å€...">
                        </div>
                        
                        <div class="input-group">
                            <label for="output-name">è¾“å‡ºMIDIæ–‡ä»¶å</label>
                            <input type="text" id="output-name" value="output.mid" placeholder="è¾“å‡ºæ–‡ä»¶å...">
                        </div>
                        
                        <button class="button success" id="download-convert-btn">
                            <span class="btn-text">ä¸‹è½½å¹¶è½¬æ¢</span>
                            <span class="spinner" style="display: none;"></span>
                        </button>
                    </div>
                    
                    <div class="tab-content" id="file-tab">
                        <div class="file-input-container">
                            <input type="file" id="file-input" accept=".ccmz">
                            <label for="file-input" class="file-input-label" id="file-input-label">
                                <i class="fas fa-file-upload"></i>
                                <span>ç‚¹å‡»é€‰æ‹©æˆ–æ‹–æ‹½CCMZæ–‡ä»¶åˆ°æ­¤åŒºåŸŸ</span>
                                <div style="margin-top: 10px; font-size: 0.9rem;">æ”¯æŒ.ccmzæ ¼å¼æ–‡ä»¶</div>
                            </label>
                        </div>
                        
                        <div class="input-group">
                            <label for="local-output-name">è¾“å‡ºMIDIæ–‡ä»¶å</label>
                            <input type="text" id="local-output-name" value="converted.mid" placeholder="è¾“å‡ºæ–‡ä»¶å...">
                        </div>
                        
                        <button class="button success" id="local-convert-btn">
                            <span class="btn-text">è½¬æ¢æœ¬åœ°æ–‡ä»¶</span>
                            <span class="spinner" style="display: none;"></span>
                        </button>
                    </div>
                </div>

                <div class="progress-container" id="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill"></div>
                    </div>
                    <div class="progress-text" id="progress-text">å‡†å¤‡ä¸­...</div>
                </div>
            </div>

            <!-- è¾“å‡ºåŒºåŸŸ -->
            <div class="card">
                <h2><i class="fas fa-download"></i> è¾“å‡ºç»“æœ</h2>
                
                <div id="status-box" class="status-box" style="display: none;">
                    <h3><i class="fas fa-info-circle"></i> å¤„ç†çŠ¶æ€</h3>
                    <div class="status-content" id="status-content">
                        <!-- æ—¥å¿—å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                    </div>
                </div>
                
                <div id="download-section" style="display: none; text-align: center; margin-top: 20px;">
                    <a href="#" class="download-link" id="download-link" download>
                        <i class="fas fa-download"></i> ä¸‹è½½MIDIæ–‡ä»¶
                    </a>
                </div>
                
                <div style="margin-top: 20px; text-align: center;">
                    <button class="button secondary" id="clear-log-btn" style="width: auto; padding: 10px 20px;">
                        <i class="fas fa-trash-alt"></i> æ¸…é™¤æ—¥å¿—
                    </button>
                </div>
            </div>
        </div>

        <footer>
            <p>Â© 2025 CCMZ to MIDI Converter | å®Œå…¨åœ¨æµè§ˆå™¨ä¸­è¿è¡Œï¼Œæ— éœ€æœåŠ¡å™¨</p>
            <p style="margin-top: 10px; font-size: 0.8rem;">
                æ³¨æ„ï¼šæ‰€æœ‰æ–‡ä»¶å¤„ç†å‡åœ¨æœ¬åœ°æµè§ˆå™¨ä¸­è¿›è¡Œï¼Œä¸ä¼šä¸Šä¼ åˆ°ä»»ä½•æœåŠ¡å™¨
            </p>
        </footer>
    </div>

    <script>
        // æ ¸å¿ƒè½¬æ¢é€»è¾‘
        class CCMZConverter {
            constructor() {
                this.statusLog = [];
                this.currentFile = null;
            }
            
            log(message, type = 'info') {
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = {
                    time: timestamp,
                    message: message,
                    type: type
                };
                
                this.statusLog.push(logEntry);
                this.updateStatusDisplay();
                
                console.log(`[${timestamp}] ${message}`);
            }
            
            updateStatusDisplay() {
                const statusContent = document.getElementById('status-content');
                if (!statusContent) return;
                
                let html = '';
                for (const entry of this.statusLog.slice(-30)) {
                    html += `<div class="log-entry log-${entry.type}">[${entry.time}] ${entry.message}</div>`;
                }
                
                statusContent.innerHTML = html;
                statusContent.scrollTop = statusContent.scrollHeight;
                
                // æ˜¾ç¤ºçŠ¶æ€æ¡†
                document.getElementById('status-box').style.display = 'block';
            }
            
            updateProgress(percentage, message) {
                const progressFill = document.getElementById('progress-fill');
                const progressText = document.getElementById('progress-text');
                const progressContainer = document.getElementById('progress-container');
                
                if (progressFill) progressFill.style.width = `${percentage}%`;
                if (progressText) progressText.textContent = message;
                if (progressContainer) progressContainer.style.display = 'block';
            }
            
            async downloadCCMZ(url) {
                this.log(`æ­£åœ¨ä» ${url} ä¸‹è½½ CCMZ æ–‡ä»¶...`, 'info');
                this.updateProgress(10, 'å¼€å§‹ä¸‹è½½æ–‡ä»¶...');
                
                try {
                    // æ·»åŠ æ—¶é—´æˆ³é˜²æ­¢ç¼“å­˜
                    const cacheBusterUrl = url + (url.includes('?') ? '&' : '?') + '_=' + Date.now();
                    
                    const response = await fetch(cacheBusterUrl, {
                        headers: {
                            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
                            'Accept': 'application/octet-stream'
                        },
                        mode: 'cors'
                    });
                    
                    if (!response.ok) {
                        throw new Error(`ä¸‹è½½å¤±è´¥ï¼ŒHTTP çŠ¶æ€ç : ${response.status}`);
                    }
                    
                    const data = await response.arrayBuffer();
                    this.updateProgress(30, 'æ–‡ä»¶ä¸‹è½½å®Œæˆ');
                    this.log(`âœ… ä¸‹è½½å®Œæˆ: ${data.byteLength.toLocaleString()} å­—èŠ‚`, 'success');
                    
                    return new Uint8Array(data);
                } catch (error) {
                    this.log(`âŒ ä¸‹è½½å¤±è´¥: ${error.message}`, 'error');
                    throw error;
                }
            }
            
            extractCCMZ(ccmzData) {
                this.log('ğŸ” æ­£åœ¨æå– CCMZ æ–‡ä»¶...', 'info');
                this.updateProgress(40, 'è§£å¯†CCMZæ–‡ä»¶...');
                
                try {
                    // ç¬¬ä¸€ä¸ªå­—èŠ‚æ˜¯ç‰ˆæœ¬å·
                    const version = ccmzData[0];
                    this.log(`ğŸ“Š CCMZ ç‰ˆæœ¬: ${version}`, 'info');
                    
                    // å‰©ä½™æ•°æ®
                    const remaining = ccmzData.slice(1);
                    
                    let decrypted;
                    if (version === 1) {
                        // ç‰ˆæœ¬1: ç›´æ¥å°±æ˜¯ZIP
                        this.log('ğŸ”“ ä½¿ç”¨ç‰ˆæœ¬1è§£å¯†ï¼ˆç›´æ¥ZIPï¼‰', 'info');
                        decrypted = remaining;
                    } else if (version === 2) {
                        // ç‰ˆæœ¬2: æ¯ä¸ªå­—èŠ‚å¥‡å¶æ€§è½¬æ¢
                        this.log('ğŸ”“ ä½¿ç”¨ç‰ˆæœ¬2è§£å¯†ï¼ˆå¥‡å¶è½¬æ¢ï¼‰...', 'info');
                        decrypted = new Uint8Array(remaining.length);
                        
                        for (let i = 0; i < remaining.length; i++) {
                            const byte = remaining[i];
                            if (byte % 2 === 0) { // å¶æ•°
                                decrypted[i] = byte + 1;
                            } else { // å¥‡æ•°
                                decrypted[i] = byte - 1;
                            }
                        }
                        
                        this.log('âœ… è§£å¯†å®Œæˆ', 'success');
                    } else {
                        throw new Error(`âŒ ä¸æ”¯æŒçš„ CCMZ ç‰ˆæœ¬: ${version}`);
                    }
                    
                    this.updateProgress(60, 'è§£å‹ZIPæ–‡ä»¶...');
                    
                    // è§£å‹ZIPæ–‡ä»¶
                    return this.extractZip(decrypted);
                } catch (error) {
                    this.log(`âŒ æå–å¤±è´¥: ${error.message}`, 'error');
                    throw error;
                }
            }
            
            async extractZip(zipData) {
                try {
                    // ä½¿ç”¨JSZipåº“è§£å‹
                    if (typeof JSZip === 'undefined') {
                        throw new Error('JSZipåº“æœªåŠ è½½ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                    }
                    
                    const zip = await JSZip.loadAsync(zipData);
                    const files = Object.keys(zip.files);
                    
                    this.log(`ğŸ“¦ æ‰¾åˆ° ${files.length} ä¸ªæ–‡ä»¶`, 'info');
                    
                    let jsonData = null;
                    
                    for (const filename of files) {
                        const file = zip.files[filename];
                        
                        // è·³è¿‡ç›®å½•
                        if (file.dir) {
                            continue;
                        }
                        
                        // æŸ¥æ‰¾ midi.json æ–‡ä»¶
                        if (filename.toLowerCase() === 'midi.json') {
                            try {
                                jsonData = await file.async('text');
                                this.log(`ğŸ¯ æ‰¾åˆ°éŸ³ä¹æ•°æ®æ–‡ä»¶`, 'success');
                                break;
                            } catch (e) {
                                this.log(`âŒ è¯»å–æ–‡ä»¶å¤±è´¥: ${e.message}`, 'error');
                            }
                        }
                    }
                    
                    if (!jsonData) {
                        throw new Error('âŒ æœªæ‰¾åˆ°éŸ³ä¹æ•°æ®');
                    }
                    
                    this.updateProgress(80, 'è§£ææ•°æ®...');
                    const parsedJson = JSON.parse(jsonData);
                    this.log('âœ… æ•°æ®è§£æå®Œæˆ', 'success');
                    
                    return parsedJson;
                } catch (error) {
                    this.log(`âŒ è§£å‹å¤±è´¥: ${error.message}`, 'error');
                    throw error;
                }
            }
            
            jsonToMidi(jsonData) {
                this.log('ğŸ”„ å¼€å§‹è½¬æ¢åˆ° MIDI...', 'info');
                this.updateProgress(90, 'ç”ŸæˆMIDIæ–‡ä»¶...');
                
                try {
                    // æå–åŸºæœ¬ä¿¡æ¯
                    const ticksPerBeat = jsonData.division || 480;
                    const events = jsonData.events || [];
                    const tracks = jsonData.tracks || [];
                    
                    // éªŒè¯ PPQ æœ‰æ•ˆæ€§
                    const validTicksPerBeat = typeof ticksPerBeat === 'number' && ticksPerBeat > 0 ? ticksPerBeat : 480;
                    
                    // ç®€åŒ–çš„ç»Ÿè®¡ä¿¡æ¯
                    const trackCount = tracks.length || 1;
                    this.log(`è½¨é“æ•°é‡: ${trackCount}`, 'info');
                    
                    // åˆ›å»ºMIDIæ•°æ®
                    const midiData = this.generateMidiWithMultipleTracks(jsonData, validTicksPerBeat);
                    
                    this.log(`âœ… è½¬æ¢å®Œæˆ`, 'success');
                    this.updateProgress(100, 'è½¬æ¢å®Œæˆï¼');
                    
                    return midiData;
                } catch (error) {
                    this.log(`âŒ MIDIè½¬æ¢å¤±è´¥: ${error.message}`, 'error');
                    throw error;
                }
            }
            
            generateMidiWithMultipleTracks(jsonData, ticksPerBeat) {
                // åˆ›å»ºå¤šè½¨é“MIDIæ–‡ä»¶
                const tracks = jsonData.tracks || [];
                const events = jsonData.events || [];
                
                // MIDIæ ¼å¼ï¼šå¦‚æœè½¨é“æ•°>1åˆ™ç”¨æ ¼å¼1ï¼Œå¦åˆ™ç”¨æ ¼å¼0
                const midiFormat = tracks.length > 1 ? 1 : 0;
                const trackCount = midiFormat === 0 ? 1 : tracks.length + 1; // æ ¼å¼1éœ€è¦é¢å¤–çš„å…ƒæ•°æ®è½¨é“
                
                // åˆ›å»ºæ–‡ä»¶å¤´
                const header = this.createMidiHeader(midiFormat, trackCount, ticksPerBeat);
                
                // æ”¶é›†æ‰€æœ‰è½¨é“æ•°æ®
                const trackChunks = [];
                
                if (midiFormat === 1) {
                    // æ ¼å¼1ï¼šç¬¬ä¸€ä¸ªè½¨é“æ˜¯å…ƒæ•°æ®è½¨é“
                    const metaTrack = this.createMetaTrack(jsonData, ticksPerBeat);
                    trackChunks.push(metaTrack);
                    
                    // ä¸ºæ¯ä¸ªéŸ³ä¹è½¨é“åˆ›å»ºè½¨é“
                    for (let i = 0; i < tracks.length; i++) {
                        const musicTrack = this.createMusicTrack(jsonData, ticksPerBeat, i);
                        trackChunks.push(musicTrack);
                    }
                } else {
                    // æ ¼å¼0ï¼šåªæœ‰ä¸€ä¸ªè½¨é“ï¼ŒåŒ…å«æ‰€æœ‰å†…å®¹
                    const singleTrack = this.createSingleTrack(jsonData, ticksPerBeat);
                    trackChunks.push(singleTrack);
                }
                
                // è®¡ç®—æ€»å¤§å°
                let totalSize = header.length;
                for (const chunk of trackChunks) {
                    totalSize += chunk.length;
                }
                
                // åˆå¹¶æ‰€æœ‰æ•°æ®
                const midiData = new Uint8Array(totalSize);
                let offset = 0;
                
                midiData.set(header, offset);
                offset += header.length;
                
                for (const chunk of trackChunks) {
                    midiData.set(chunk, offset);
                    offset += chunk.length;
                }
                
                return midiData;
            }
            
            createMidiHeader(format, trackCount, ticksPerBeat) {
                const buffer = new ArrayBuffer(14);
                const view = new DataView(buffer);
                
                // MIDIæ–‡ä»¶å¤´æ ‡è¯† "MThd"
                view.setUint8(0, 0x4D); // M
                view.setUint8(1, 0x54); // T
                view.setUint8(2, 0x68); // h
                view.setUint8(3, 0x64); // d
                
                // å¤´éƒ¨é•¿åº¦ (6å­—èŠ‚)
                view.setUint32(4, 6, false);
                
                // æ ¼å¼ç±»å‹ (0: å•è½¨é“, 1: å¤šè½¨é“åŒæ­¥)
                view.setUint16(8, format, false);
                
                // è½¨é“æ•°é‡
                view.setUint16(10, trackCount, false);
                
                // æ—¶é—´ç²¾åº¦ (ticks per beat)
                view.setUint16(12, ticksPerBeat, false);
                
                return new Uint8Array(buffer);
            }
            
            createMetaTrack(jsonData, ticksPerBeat) {
                const events = [];
                
                // æ·»åŠ é€Ÿåº¦äº‹ä»¶
                const tempos = jsonData.tempos || [];
                if (tempos.length === 0) {
                    // é»˜è®¤é€Ÿåº¦ (120 BPM = 500000å¾®ç§’/å››åˆ†éŸ³ç¬¦)
                    events.push({
                        deltaTime: 0,
                        type: 'tempo',
                        value: 500000
                    });
                } else {
                    let lastTick = 0;
                    for (const tempo of tempos) {
                        const tick = tempo.tick || 0;
                        const tempoValue = tempo.tempo || 500000;
                        events.push({
                            deltaTime: tick - lastTick,
                            type: 'tempo',
                            value: tempoValue
                        });
                        lastTick = tick;
                    }
                }
                
                // æ·»åŠ æ‹å·äº‹ä»¶
                const beatInfos = jsonData.beatInfos || [];
                if (beatInfos.length === 0) {
                    // é»˜è®¤æ‹å· 4/4
                    events.push({
                        deltaTime: 0,
                        type: 'timeSignature',
                        numerator: 4,
                        denominator: 4
                    });
                } else {
                    let lastTick = 0;
                    for (const beat of beatInfos) {
                        const tick = beat.tick || 0;
                        const numerator = beat.beats || 4;
                        const denominator = beat.beatsUnit || 4;
                        events.push({
                            deltaTime: tick - lastTick,
                            type: 'timeSignature',
                            numerator: numerator,
                            denominator: denominator
                        });
                        lastTick = tick;
                    }
                }
                
                // æ·»åŠ è½¨é“ç»“æŸäº‹ä»¶
                events.push({
                    deltaTime: 0,
                    type: 'endOfTrack'
                });
                
                // ç¼–ç è½¨é“æ•°æ®
                return this.encodeTrackChunk(events);
            }
            
            createMusicTrack(jsonData, ticksPerBeat, trackIndex) {
                const events = [];
                const allEvents = jsonData.events || [];
                const tracks = jsonData.tracks || [];
                
                // è·å–å½“å‰è½¨é“çš„é…ç½®
                const trackConfig = tracks[trackIndex] || {};
                const channel = trackConfig.channel || trackIndex;
                const program = trackConfig.program || 0;
                
                // æ·»åŠ éŸ³è‰²å˜æ›´äº‹ä»¶
                if (program >= 0) {
                    events.push({
                        deltaTime: 0,
                        type: 'programChange',
                        channel: channel % 16, // MIDIé€šé“0-15
                        program: program
                    });
                }
                
                // è¿‡æ»¤å‡ºå½“å‰è½¨é“çš„äº‹ä»¶
                const trackEvents = allEvents.filter(event => {
                    const eventTrack = event.track || 0;
                    return eventTrack === trackIndex;
                });
                
                // æŒ‰tickæ’åº
                trackEvents.sort((a, b) => (a.tick || 0) - (b.tick || 0));
                
                // å¤„ç†äº‹ä»¶
                let lastTick = 0;
                
                for (const event of trackEvents) {
                    const tick = event.tick || 0;
                    const delta = tick - lastTick;
                    const eventData = event.event || [];
                    
                    if (eventData.length >= 3) {
                        const status = eventData[0];
                        const msgType = status & 0xF0;
                        const eventChannel = status & 0x0F;
                        
                        // ä½¿ç”¨é…ç½®çš„é€šé“ï¼Œä½†äº‹ä»¶ä¸­å¯èƒ½æŒ‡å®šäº†é€šé“
                        const finalChannel = eventChannel !== 0 ? eventChannel : channel % 16;
                        
                        if (msgType === 0x90 || msgType === 0x80) {
                            // Note On æˆ– Note Off
                            const note = eventData[1];
                            const velocity = eventData[2];
                            
                            if (msgType === 0x90 && velocity > 0) {
                                // Note On
                                events.push({
                                    deltaTime: delta,
                                    type: 'noteOn',
                                    channel: finalChannel,
                                    note: note,
                                    velocity: velocity
                                });
                            } else {
                                // Note Off æˆ– velocity=0çš„Note On
                                events.push({
                                    deltaTime: delta,
                                    type: 'noteOff',
                                    channel: finalChannel,
                                    note: note,
                                    velocity: 0
                                });
                            }
                            
                            lastTick = tick;
                        }
                    }
                }
                
                // æ·»åŠ è½¨é“ç»“æŸäº‹ä»¶
                events.push({
                    deltaTime: 0,
                    type: 'endOfTrack'
                });
                
                // ç¼–ç è½¨é“æ•°æ®
                return this.encodeTrackChunk(events);
            }
            
            createSingleTrack(jsonData, ticksPerBeat) {
                const events = [];
                
                // æ·»åŠ é€Ÿåº¦äº‹ä»¶
                const tempos = jsonData.tempos || [];
                if (tempos.length === 0) {
                    // é»˜è®¤é€Ÿåº¦ (120 BPM = 500000å¾®ç§’/å››åˆ†éŸ³ç¬¦)
                    events.push({
                        deltaTime: 0,
                        type: 'tempo',
                        value: 500000
                    });
                } else {
                    let lastTick = 0;
                    for (const tempo of tempos) {
                        const tick = tempo.tick || 0;
                        const tempoValue = tempo.tempo || 500000;
                        events.push({
                            deltaTime: tick - lastTick,
                            type: 'tempo',
                            value: tempoValue
                        });
                        lastTick = tick;
                    }
                }
                
                // æ·»åŠ æ‹å·äº‹ä»¶
                const beatInfos = jsonData.beatInfos || [];
                if (beatInfos.length === 0) {
                    // é»˜è®¤æ‹å· 4/4
                    events.push({
                        deltaTime: 0,
                        type: 'timeSignature',
                        numerator: 4,
                        denominator: 4
                    });
                } else {
                    let lastTick = 0;
                    for (const beat of beatInfos) {
                        const tick = beat.tick || 0;
                        const numerator = beat.beats || 4;
                        const denominator = beat.beatsUnit || 4;
                        events.push({
                            deltaTime: tick - lastTick,
                            type: 'timeSignature',
                            numerator: numerator,
                            denominator: denominator
                        });
                        lastTick = tick;
                    }
                }
                
                // æ·»åŠ éŸ³è‰²å˜æ›´äº‹ä»¶
                const tracks = jsonData.tracks || [];
                if (tracks.length > 0) {
                    const track = tracks[0];
                    if (track.program >= 0) {
                        events.push({
                            deltaTime: 0,
                            type: 'programChange',
                            channel: track.channel || 0,
                            program: track.program
                        });
                    }
                }
                
                // å¤„ç†æ‰€æœ‰äº‹ä»¶ï¼ˆä¸åˆ†è½¨é“ï¼‰
                const allEvents = jsonData.events || [];
                allEvents.sort((a, b) => (a.tick || 0) - (b.tick || 0));
                
                let lastTick = 0;
                
                for (const event of allEvents) {
                    const tick = event.tick || 0;
                    const delta = tick - lastTick;
                    const eventData = event.event || [];
                    
                    if (eventData.length >= 3) {
                        const status = eventData[0];
                        const msgType = status & 0xF0;
                        const channel = status & 0x0F;
                        
                        if (msgType === 0x90 || msgType === 0x80) {
                            // Note On æˆ– Note Off
                            const note = eventData[1];
                            const velocity = eventData[2];
                            
                            if (msgType === 0x90 && velocity > 0) {
                                // Note On
                                events.push({
                                    deltaTime: delta,
                                    type: 'noteOn',
                                    channel: channel,
                                    note: note,
                                    velocity: velocity
                                });
                            } else {
                                // Note Off æˆ– velocity=0çš„Note On
                                events.push({
                                    deltaTime: delta,
                                    type: 'noteOff',
                                    channel: channel,
                                    note: note,
                                    velocity: 0
                                });
                            }
                            
                            lastTick = tick;
                        }
                    }
                }
                
                // æ·»åŠ è½¨é“ç»“æŸäº‹ä»¶
                events.push({
                    deltaTime: 0,
                    type: 'endOfTrack'
                });
                
                // ç¼–ç è½¨é“æ•°æ®
                return this.encodeTrackChunk(events);
            }
            
            encodeTrackChunk(events) {
                // é¦–å…ˆè®¡ç®—éœ€è¦çš„æ€»å¤§å°
                let trackDataSize = 0;
                
                for (const event of events) {
                    // delta timeçš„å¤§å°
                    trackDataSize += this.calculateVarIntSize(event.deltaTime || 0);
                    
                    // äº‹ä»¶æ•°æ®çš„å¤§å°
                    switch (event.type) {
                        case 'tempo':
                            trackDataSize += 6; // FF 51 03 + 3å­—èŠ‚tempo
                            break;
                        case 'timeSignature':
                            trackDataSize += 7; // FF 58 04 + 4å­—èŠ‚
                            break;
                        case 'programChange':
                            trackDataSize += 2; // Cx + program
                            break;
                        case 'noteOn':
                            trackDataSize += 3; // 9x + note + velocity
                            break;
                        case 'noteOff':
                            trackDataSize += 3; // 8x + note + velocity
                            break;
                        case 'endOfTrack':
                            trackDataSize += 3; // FF 2F 00
                            break;
                    }
                }
                
                // åˆ›å»ºè½¨é“å—ç¼“å†²åŒº (8å­—èŠ‚å¤´ + è½¨é“æ•°æ®)
                const buffer = new ArrayBuffer(8 + trackDataSize);
                const view = new DataView(buffer);
                let offset = 0;
                
                // å†™å…¥è½¨é“å¤´ "MTrk"
                view.setUint8(offset++, 0x4D); // M
                view.setUint8(offset++, 0x54); // T
                view.setUint8(offset++, 0x72); // r
                view.setUint8(offset++, 0x6B); // k
                
                // å†™å…¥è½¨é“é•¿åº¦
                view.setUint32(offset, trackDataSize, false);
                offset += 4;
                
                // å†™å…¥äº‹ä»¶
                for (const event of events) {
                    // å†™å…¥delta time
                    offset = this.writeVarInt(view, offset, event.deltaTime || 0);
                    
                    switch (event.type) {
                        case 'tempo':
                            view.setUint8(offset++, 0xFF);
                            view.setUint8(offset++, 0x51);
                            view.setUint8(offset++, 0x03);
                            const tempo = event.value || 500000;
                            view.setUint8(offset++, (tempo >> 16) & 0xFF);
                            view.setUint8(offset++, (tempo >> 8) & 0xFF);
                            view.setUint8(offset++, tempo & 0xFF);
                            break;
                            
                        case 'timeSignature':
                            view.setUint8(offset++, 0xFF);
                            view.setUint8(offset++, 0x58);
                            view.setUint8(offset++, 0x04);
                            view.setUint8(offset++, event.numerator || 4);
                            
                            // åˆ†æ¯æ˜¯2çš„å¹‚æ¬¡ï¼Œ4=2^2, 2=2^1, 8=2^3, 16=2^4
                            let denominatorPower = 2;
                            if (event.denominator === 2) denominatorPower = 1;
                            else if (event.denominator === 8) denominatorPower = 3;
                            else if (event.denominator === 16) denominatorPower = 4;
                            
                            view.setUint8(offset++, denominatorPower);
                            view.setUint8(offset++, 24); // MIDIæ—¶é’Ÿæ¯å››åˆ†éŸ³ç¬¦çš„æ»´ç­”æ•°
                            view.setUint8(offset++, 8);  // 32åˆ†éŸ³ç¬¦çš„æ•°é‡
                            break;
                            
                        case 'programChange':
                            view.setUint8(offset++, 0xC0 | (event.channel || 0));
                            view.setUint8(offset++, event.program || 0);
                            break;
                            
                        case 'noteOn':
                            view.setUint8(offset++, 0x90 | (event.channel || 0));
                            view.setUint8(offset++, event.note || 60);
                            view.setUint8(offset++, event.velocity || 64);
                            break;
                            
                        case 'noteOff':
                            view.setUint8(offset++, 0x80 | (event.channel || 0));
                            view.setUint8(offset++, event.note || 60);
                            view.setUint8(offset++, 0);
                            break;
                            
                        case 'endOfTrack':
                            view.setUint8(offset++, 0xFF);
                            view.setUint8(offset++, 0x2F);
                            view.setUint8(offset++, 0x00);
                            break;
                    }
                }
                
                return new Uint8Array(buffer);
            }
            
            calculateVarIntSize(value) {
                value = Math.floor(value);
                let size = 0;
                
                do {
                    value >>= 7;
                    size++;
                } while (value > 0);
                
                return size;
            }
            
            writeVarInt(view, offset, value) {
                value = Math.floor(value);
                const bytes = [];
                
                do {
                    let byte = value & 0x7F;
                    value >>= 7;
                    if (bytes.length > 0) byte |= 0x80;
                    bytes.push(byte);
                } while (value > 0);
                
                for (let i = bytes.length - 1; i >= 0; i--) {
                    view.setUint8(offset++, bytes[i]);
                }
                
                return offset;
            }
            
            async convertFromURL(url, outputFilename) {
                try {
                    this.resetState();
                    this.log('å¼€å§‹ä»URLè½¬æ¢CCMZæ–‡ä»¶...', 'info');
                    
                    // ä¸‹è½½CCMZæ–‡ä»¶
                    const ccmzData = await this.downloadCCMZ(url);
                    
                    // æå–å’Œè½¬æ¢
                    const jsonData = await this.extractCCMZ(ccmzData);
                    const midiData = this.jsonToMidi(jsonData);
                    
                    // ä¿å­˜æ–‡ä»¶
                    this.saveMidiFile(midiData, outputFilename);
                    
                    return true;
                } catch (error) {
                    this.log(`è½¬æ¢å¤±è´¥: ${error.message}`, 'error');
                    return false;
                }
            }
            
            async convertFromFile(file, outputFilename) {
                try {
                    this.resetState();
                    this.log(`å¼€å§‹è½¬æ¢æœ¬åœ°æ–‡ä»¶: ${file.name}`, 'info');
                    
                    // è¯»å–æ–‡ä»¶
                    const arrayBuffer = await file.arrayBuffer();
                    const ccmzData = new Uint8Array(arrayBuffer);
                    
                    this.updateProgress(20, 'æ–‡ä»¶è¯»å–å®Œæˆ');
                    
                    // æå–å’Œè½¬æ¢
                    const jsonData = await this.extractCCMZ(ccmzData);
                    const midiData = this.jsonToMidi(jsonData);
                    
                    // ä¿å­˜æ–‡ä»¶
                    this.saveMidiFile(midiData, outputFilename);
                    
                    return true;
                } catch (error) {
                    this.log(`è½¬æ¢å¤±è´¥: ${error.message}`, 'error');
                    return false;
                }
            }
            
            saveMidiFile(midiData, filename) {
                // åˆ›å»ºBlobå¹¶ä¸‹è½½
                const blob = new Blob([midiData], { type: 'audio/midi' });
                const url = URL.createObjectURL(blob);
                
                // æ›´æ–°ä¸‹è½½é“¾æ¥
                const downloadLink = document.getElementById('download-link');
                downloadLink.href = url;
                downloadLink.download = filename;
                
                // æ˜¾ç¤ºä¸‹è½½é“¾æ¥
                document.getElementById('download-section').style.display = 'block';
                
                this.log(`âœ… MIDIæ–‡ä»¶å·²ç”Ÿæˆ: ${filename}`, 'success');
                this.log(`æ–‡ä»¶å¤§å°: ${midiData.length.toLocaleString()} å­—èŠ‚`, 'info');
            }
            
            resetState() {
                this.statusLog = [];
                this.updateProgress(0, 'å‡†å¤‡ä¸­...');
                
                // éšè—ä¹‹å‰çš„ä¸‹è½½é“¾æ¥
                document.getElementById('download-section').style.display = 'none';
            }
        }

        // åˆå§‹åŒ–åº”ç”¨
        document.addEventListener('DOMContentLoaded', function() {
            const converter = new CCMZConverter();
            
            // æ ‡ç­¾åˆ‡æ¢åŠŸèƒ½
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    
                    // ç§»é™¤æ‰€æœ‰activeç±»
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    // æ·»åŠ activeç±»
                    this.classList.add('active');
                    document.getElementById(tabId).classList.add('active');
                });
            });
            
            // æ–‡ä»¶æ‹–æ”¾åŠŸèƒ½
            const fileInput = document.getElementById('file-input');
            const fileInputLabel = document.getElementById('file-input-label');
            
            fileInput.addEventListener('change', function() {
                if (this.files.length > 0) {
                    const fileName = this.files[0].name;
                    fileInputLabel.innerHTML = `
                        <i class="fas fa-file-music" style="color: #4cc9f0;"></i>
                        <span>å·²é€‰æ‹©æ–‡ä»¶: ${fileName}</span>
                        <div style="margin-top: 10px; font-size: 0.9rem;">ç‚¹å‡»é‡æ–°é€‰æ‹©</div>
                    `;
                    fileInputLabel.classList.add('file-selected');
                }
            });
            
            // æ‹–æ”¾äº‹ä»¶
            fileInputLabel.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.style.borderColor = '#4361ee';
                this.style.backgroundColor = 'rgba(67, 97, 238, 0.05)';
            });
            
            fileInputLabel.addEventListener('dragleave', function(e) {
                e.preventDefault();
                this.style.borderColor = '#ddd';
                this.style.backgroundColor = '';
            });
            
            fileInputLabel.addEventListener('drop', function(e) {
                e.preventDefault();
                this.style.borderColor = '#ddd';
                this.style.backgroundColor = '';
                
                if (e.dataTransfer.files.length > 0) {
                    const file = e.dataTransfer.files[0];
                    if (file.name.toLowerCase().endsWith('.ccmz')) {
                        // åˆ›å»ºDataTransferå¯¹è±¡æ¥è®¾ç½®æ–‡ä»¶
                        const dataTransfer = new DataTransfer();
                        dataTransfer.items.add(file);
                        fileInput.files = dataTransfer.files;
                        
                        // è§¦å‘changeäº‹ä»¶
                        fileInput.dispatchEvent(new Event('change'));
                    } else {
                        alert('è¯·é€‰æ‹©.ccmzæ ¼å¼çš„æ–‡ä»¶');
                    }
                }
            });
            
            // ä»URLä¸‹è½½å¹¶è½¬æ¢
            document.getElementById('download-convert-btn').addEventListener('click', async function() {
                const url = document.getElementById('url-input').value.trim();
                const outputName = document.getElementById('output-name').value.trim() || 'output.mid';
                
                if (!url) {
                    alert('è¯·è¾“å…¥CCMZæ–‡ä»¶çš„URLåœ°å€');
                    return;
                }
                
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                const btnText = this.querySelector('.btn-text');
                const spinner = this.querySelector('.spinner');
                btnText.textContent = 'è½¬æ¢ä¸­...';
                spinner.style.display = 'inline-block';
                this.disabled = true;
                
                try {
                    await converter.convertFromURL(url, outputName);
                } catch (error) {
                    console.error('è½¬æ¢é”™è¯¯:', error);
                } finally {
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    btnText.textContent = 'ä¸‹è½½å¹¶è½¬æ¢';
                    spinner.style.display = 'none';
                    this.disabled = false;
                }
            });
            
            // è½¬æ¢æœ¬åœ°æ–‡ä»¶
            document.getElementById('local-convert-btn').addEventListener('click', async function() {
                const file = fileInput.files[0];
                const outputName = document.getElementById('local-output-name').value.trim() || 'converted.mid';
                
                if (!file) {
                    alert('è¯·é€‰æ‹©CCMZæ–‡ä»¶');
                    return;
                }
                
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                const btnText = this.querySelector('.btn-text');
                const spinner = this.querySelector('.spinner');
                btnText.textContent = 'è½¬æ¢ä¸­...';
                spinner.style.display = 'inline-block';
                this.disabled = true;
                
                try {
                    await converter.convertFromFile(file, outputName);
                } catch (error) {
                    console.error('è½¬æ¢é”™è¯¯:', error);
                } finally {
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    btnText.textContent = 'è½¬æ¢æœ¬åœ°æ–‡ä»¶';
                    spinner.style.display = 'none';
                    this.disabled = false;
                }
            });
            
            // æ¸…é™¤æ—¥å¿—
            document.getElementById('clear-log-btn').addEventListener('click', function() {
                converter.statusLog = [];
                converter.updateStatusDisplay();
            });
            
            // åˆå§‹åŒ–æ—¥å¿—æ˜¾ç¤º
            converter.log('CCMZ åˆ° MIDI è½¬æ¢å·¥å…·å·²å°±ç»ª', 'info');
            converter.log('é€‰æ‹©è¾“å…¥æºå¼€å§‹è½¬æ¢', 'info');
        });
    </script>
    
    <!-- å¼•å…¥JSZipåº“ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</body>
</html>