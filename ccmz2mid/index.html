<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="referrer" content="no-referrer">
    <title>è™«è™«é’¢ç´CCMZè½¬MIDIåœ¨çº¿å·¥å…·</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* M3 Design System é¢œè‰²å˜é‡ */
        :root {
            --primary: #6750A4;
            --primary-container: #EADDFF;
            --secondary: #625B71;
            --secondary-container: #E8DEF8;
            --tertiary: #7D5260;
            --tertiary-container: #FFD8E4;
            --surface: #FFFBFE;
            --surface-variant: #E7E0EC;
            --outline: #79747E;
            --outline-variant: #CAC4D0;
            --error: #B3261E;
            --error-container: #F9DEDC;
            --success: #0D6E42;
            --success-container: #A7F0BA;
            --on-primary: #FFFFFF;
            --on-primary-container: #21005D;
            --on-secondary: #FFFFFF;
            --on-secondary-container: #1D192B;
            --on-surface: #1C1B1F;
            --on-surface-variant: #49454F;
            --on-error: #FFFFFF;
            --on-error-container: #410E0B;
            --on-success: #FFFFFF;
            --on-success-container: #00210B;
            
            /* å­—ä½“å˜é‡ - æ¡Œé¢ç«¯æ›´å¤§ */
            --font-family: 'Roboto', 'Segoe UI', 'Microsoft YaHei', sans-serif;
            --font-size-xs: 0.75rem;   /* 12px */
            --font-size-sm: 0.875rem;  /* 14px */
            --font-size-md: 1rem;      /* 16px */
            --font-size-lg: 1.125rem;  /* 18px */
            --font-size-xl: 1.25rem;   /* 20px */
            --font-size-2xl: 1.5rem;   /* 24px */
            --font-size-3xl: 1.875rem; /* 30px */
            --font-size-4xl: 2.25rem;  /* 36px - æ¡Œé¢ç«¯æ ‡é¢˜ */
            
            /* é—´è·å˜é‡ - æ¡Œé¢ç«¯æ›´å¤§ */
            --space-xs: 0.25rem;   /* 4px */
            --space-sm: 0.5rem;    /* 8px */
            --space-md: 1rem;      /* 16px */
            --space-lg: 1.5rem;    /* 24px */
            --space-xl: 2rem;      /* 32px */
            --space-2xl: 3rem;     /* 48px */
            --space-3xl: 4rem;     /* 64px - æ¡Œé¢ç«¯ */
            
            /* åœ†è§’å˜é‡ */
            --radius-xs: 4px;
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 20px;
            --radius-full: 9999px;
            
            /* é«˜åº¦å˜é‡ - ç§»åŠ¨ç«¯å‹å¥½ */
            --touch-target-min: 44px;
            --touch-target-md: 48px;
            --touch-target-lg: 56px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: var(--font-family);
            font-size: var(--font-size-md);
            line-height: 1.5;
            color: var(--on-surface);
            background-color: var(--surface);
            min-height: 100vh;
            padding: var(--space-md);
        }

        /* ç§»åŠ¨ç«¯å®¹å™¨ */
        .container {
            max-width: 100%;
            margin: 0 auto;
        }

        /* å¤´éƒ¨æ ·å¼ */
        header {
            text-align: center;
            margin-bottom: var(--space-xl);
            padding: var(--space-lg);
            background-color: var(--surface);
            border-radius: var(--radius-lg);
            border: 1px solid var(--outline-variant);
        }

        h1 {
            font-size: var(--font-size-2xl);
            font-weight: 400;
            color: var(--on-surface);
            margin-bottom: var(--space-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-sm);
            line-height: 1.2;
        }

        h1 i {
            color: var(--primary);
        }

        .subtitle {
            font-size: var(--font-size-sm);
            color: var(--on-surface-variant);
            line-height: 1.4;
        }

        /* ä¸»å†…å®¹åŒºåŸŸ - ç§»åŠ¨ç«¯å•åˆ—å¸ƒå±€ */
        .main-content {
            display: flex;
            flex-direction: column;
            gap: var(--space-xl);
            margin-bottom: var(--space-xl);
        }

        /* å¡ç‰‡æ ·å¼ */
        .card {
            background-color: var(--surface);
            border-radius: var(--radius-lg);
            border: 1px solid var(--outline-variant);
            padding: var(--space-lg);
            position: relative;
        }

        .card h2 {
            font-size: var(--font-size-xl);
            font-weight: 400;
            color: var(--on-surface);
            margin-bottom: var(--space-lg);
            padding-bottom: var(--space-sm);
            border-bottom: 1px solid var(--outline-variant);
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .card h2 i {
            color: var(--primary);
        }

        /* è¾“å…¥ç»„æ ·å¼ */
        .input-group {
            margin-bottom: var(--space-lg);
        }

        .input-group label {
            display: block;
            margin-bottom: var(--space-xs);
            font-weight: 500;
            color: var(--on-surface-variant);
            font-size: var(--font-size-sm);
        }

        .input-group input,
        .input-group textarea {
            width: 100%;
            padding: var(--space-sm) var(--space-md);
            border: 1px solid var(--outline);
            border-radius: var(--radius-md);
            font-size: var(--font-size-md);
            font-family: inherit;
            background-color: var(--surface);
            color: var(--on-surface);
            min-height: var(--touch-target-md);
        }

        .input-group input:focus,
        .input-group textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* æŒ‰é’®æ ·å¼ */
        .button {
            display: block;
            width: 100%;
            padding: var(--space-md) var(--space-lg);
            background-color: var(--primary);
            color: var(--on-primary);
            border: none;
            border-radius: var(--radius-md);
            font-size: var(--font-size-md);
            font-weight: 500;
            cursor: pointer;
            text-align: center;
            min-height: var(--touch-target-lg);
            transition: none;
            position: relative;
            overflow: hidden;
        }

        .button:active {
            background-color: var(--primary-container);
            color: var(--on-primary-container);
        }

        .button:disabled {
            background-color: var(--outline-variant);
            color: var(--on-surface-variant);
            cursor: not-allowed;
        }

        .button.secondary {
            background-color: var(--secondary-container);
            color: var(--on-secondary-container);
        }

        .button.secondary:active {
            background-color: var(--secondary);
            color: var(--on-secondary);
        }

        .button.success {
            background-color: var(--success);
            color: var(--on-success);
        }

        .button.success:active {
            background-color: var(--success-container);
            color: var(--on-success-container);
        }

        .button.danger {
            background-color: var(--error);
            color: var(--on-error);
        }

        .button.danger:active {
            background-color: var(--error-container);
            color: var(--on-error-container);
        }

        /* æ–‡ä»¶è¾“å…¥å®¹å™¨ */
        .file-input-container {
            position: relative;
            margin-bottom: var(--space-lg);
        }

        .file-input-container input[type="file"] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-input-label {
            display: block;
            padding: var(--space-xl);
            border: 2px dashed var(--outline);
            border-radius: var(--radius-md);
            text-align: center;
            color: var(--on-surface-variant);
            cursor: pointer;
            min-height: 140px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .file-input-label:active {
            border-color: var(--primary);
            background-color: var(--primary-container);
        }

        .file-input-label i {
            font-size: 2.5rem;
            margin-bottom: var(--space-sm);
            color: var(--primary);
        }

        .file-selected {
            border-color: var(--success);
            background-color: var(--success-container);
        }

        /* çŠ¶æ€æ¡† - ä¼˜åŒ–é•¿æ–‡æœ¬æ˜¾ç¤º */
        .status-box {
            margin-top: var(--space-lg);
            padding: var(--space-md);
            background-color: var(--surface-variant);
            border-radius: var(--radius-md);
            border-left: 4px solid var(--primary);
            display: none;
        }

        .status-box h3 {
            margin-bottom: var(--space-sm);
            color: var(--on-surface-variant);
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            font-size: var(--font-size-md);
            font-weight: 500;
        }

        .status-content {
            max-height: 300px; /* æ¡Œé¢ç«¯å¢åŠ é«˜åº¦ */
            overflow-y: auto;
            font-family: 'Roboto Mono', monospace;
            font-size: var(--font-size-sm);
            line-height: 1.4;
            padding: var(--space-sm);
            background-color: var(--surface);
            border-radius: var(--radius-sm);
            border: 1px solid var(--outline-variant);
            /* å…³é”®æ”¹è¿›ï¼šå¤„ç†é•¿URLå’Œé•¿æ–‡æœ¬ */
            word-wrap: break-word;
            word-break: break-word;
            overflow-wrap: break-word;
            white-space: pre-wrap;
        }

        .log-entry {
            margin-bottom: var(--space-xs);
            padding-bottom: var(--space-xs);
            border-bottom: 1px solid var(--outline-variant);
            /* ç¡®ä¿é•¿URLå¯ä»¥æ¢è¡Œ */
            word-break: break-all;
            white-space: normal;
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-success {
            color: var(--success);
        }

        .log-error {
            color: var(--error);
        }

        .log-warning {
            color: var(--tertiary);
        }

        .log-info {
            color: var(--secondary);
        }

        /* è¿›åº¦æ¡å®¹å™¨ */
        .progress-container {
            margin-top: var(--space-lg);
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background-color: var(--surface-variant);
            border-radius: var(--radius-full);
            overflow: hidden;
            margin-bottom: var(--space-sm);
        }

        .progress-fill {
            height: 100%;
            background-color: var(--primary);
            width: 0%;
        }

        .progress-text {
            text-align: center;
            font-size: var(--font-size-sm);
            color: var(--on-surface-variant);
        }

        /* ä¸‹è½½é“¾æ¥ */
        .download-link {
            display: block;
            padding: var(--space-md) var(--space-lg);
            background-color: var(--success);
            color: var(--on-success);
            text-decoration: none;
            border-radius: var(--radius-md);
            font-weight: 500;
            text-align: center;
            min-height: var(--touch-target-lg);
        }

        .download-link:active {
            background-color: var(--success-container);
            color: var(--on-success-container);
        }

        /* é¡µè„š */
        footer {
            text-align: center;
            margin-top: var(--space-xl);
            padding: var(--space-lg);
            color: var(--on-surface-variant);
            font-size: var(--font-size-sm);
            border-top: 1px solid var(--outline-variant);
        }

        /* æ ‡ç­¾é¡µæ ·å¼ */
        .tab-container {
            margin-bottom: var(--space-lg);
        }
        
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--outline-variant);
            margin-bottom: var(--space-lg);
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none; /* Firefox */
        }
        
        .tabs::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Edge */
        }
        
        .tab {
            flex: 1;
            min-width: 120px;
            padding: var(--space-md) var(--space-sm);
            background: none;
            border: none;
            font-size: var(--font-size-md);
            cursor: pointer;
            color: var(--on-surface-variant);
            border-bottom: 3px solid transparent;
            white-space: nowrap;
            min-height: var(--touch-target-min);
            text-align: center;
        }
        
        .tab:active {
            color: var(--primary);
            background-color: var(--primary-container);
        }
        
        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            font-weight: 500;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }

        /* å·¥å…·æŒ‰é’®ç»„ */
        .tool-buttons {
            display: flex;
            gap: var(--space-sm);
            margin-top: var(--space-lg);
        }

        .tool-buttons .button {
            flex: 1;
            width: auto;
        }

        /* æ¡Œé¢ç«¯å¤§å±å¹•ä¼˜åŒ– */
        @media (min-width: 768px) {
            .container {
                max-width: 1200px;
                padding: var(--space-xl) var(--space-2xl);
            }
            
            h1 {
                font-size: var(--font-size-4xl);
                margin-bottom: var(--space-md);
            }
            
            .subtitle {
                font-size: var(--font-size-lg);
                max-width: 800px;
                margin: 0 auto;
            }
            
            .main-content {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: var(--space-2xl);
                margin-bottom: var(--space-2xl);
            }
            
            .card {
                padding: var(--space-xl);
                border-radius: var(--radius-xl);
            }
            
            .card h2 {
                font-size: var(--font-size-2xl);
                margin-bottom: var(--space-xl);
                padding-bottom: var(--space-md);
            }
            
            .input-group {
                margin-bottom: var(--space-xl);
            }
            
            .input-group label {
                font-size: var(--font-size-md);
                margin-bottom: var(--space-sm);
            }
            
            .input-group input,
            .input-group textarea {
                padding: var(--space-md) var(--space-lg);
                font-size: var(--font-size-lg);
                min-height: var(--touch-target-lg);
            }
            
            .button {
                padding: var(--space-lg) var(--space-xl);
                font-size: var(--font-size-lg);
                min-height: 60px;
                border-radius: var(--radius-lg);
            }
            
            .file-input-label {
                padding: var(--space-2xl);
                min-height: 180px;
                border-radius: var(--radius-lg);
            }
            
            .file-input-label i {
                font-size: 3.5rem;
                margin-bottom: var(--space-md);
            }
            
            .status-content {
                max-height: 400px;
                font-size: var(--font-size-md);
                padding: var(--space-md);
                border-radius: var(--radius-md);
            }
            
            .status-box {
                padding: var(--space-lg);
                border-radius: var(--radius-lg);
            }
            
            .status-box h3 {
                font-size: var(--font-size-lg);
                margin-bottom: var(--space-md);
            }
            
            .progress-container {
                margin-top: var(--space-xl);
            }
            
            .progress-bar {
                height: 10px;
                border-radius: var(--radius-full);
            }
            
            .progress-text {
                font-size: var(--font-size-md);
            }
            
            .download-link {
                padding: var(--space-lg) var(--space-xl);
                font-size: var(--font-size-lg);
                min-height: 60px;
                border-radius: var(--radius-lg);
            }
            
            .tool-buttons {
                gap: var(--space-md);
                margin-top: var(--space-xl);
            }
            
            .tool-buttons .button {
                padding: var(--space-md) var(--space-lg);
                font-size: var(--font-size-md);
                min-height: var(--touch-target-lg);
            }
            
            footer {
                margin-top: var(--space-2xl);
                padding: var(--space-xl);
                font-size: var(--font-size-md);
            }
            
            .tabs {
                margin-bottom: var(--space-xl);
            }
            
            .tab {
                padding: var(--space-lg) var(--space-md);
                font-size: var(--font-size-lg);
                min-height: var(--touch-target-lg);
            }
        }

        /* å¹³æ¿ç«¯ä¼˜åŒ– */
        @media (min-width: 640px) and (max-width: 767px) {
            .container {
                max-width: 100%;
                padding: var(--space-lg);
            }
            
            h1 {
                font-size: var(--font-size-3xl);
            }
            
            .subtitle {
                font-size: var(--font-size-md);
            }
            
            .card {
                padding: var(--space-xl);
            }
            
            .card h2 {
                font-size: var(--font-size-xl);
            }
        }

        /* è¶…å°å±å¹•ä¼˜åŒ– */
        @media (max-width: 360px) {
            body {
                padding: var(--space-sm);
            }
            
            header, .card {
                padding: var(--space-md);
            }
            
            h1 {
                font-size: var(--font-size-xl);
                flex-direction: column;
                gap: var(--space-xs);
            }
            
            .file-input-label {
                padding: var(--space-lg);
                min-height: 120px;
            }
            
            .file-input-label i {
                font-size: 2rem;
            }
            
            .status-content {
                font-size: var(--font-size-xs);
                max-height: 150px;
            }
        }

        /* åŠ è½½æŒ‡ç¤ºå™¨ */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid var(--outline-variant);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s linear infinite;
            vertical-align: middle;
            margin-left: var(--space-sm);
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ç§»åŠ¨ç«¯åº•éƒ¨å®‰å…¨åŒºåŸŸ */
        @supports (padding: max(0px)) {
            body {
                padding-left: max(var(--space-md), env(safe-area-inset-left));
                padding-right: max(var(--space-md), env(safe-area-inset-right));
                padding-bottom: max(var(--space-md), env(safe-area-inset-bottom));
            }
            
            @media (min-width: 768px) {
                body {
                    padding-left: max(var(--space-xl), env(safe-area-inset-left));
                    padding-right: max(var(--space-xl), env(safe-area-inset-right));
                    padding-bottom: max(var(--space-xl), env(safe-area-inset-bottom));
                }
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>CCMZ è½¬ MIDI å·¥å…·</h1>
            <p class="subtitle">åœ¨çº¿å°†è™«è™«é’¢ç´CCMZæ–‡ä»¶è½¬æ¢ä¸ºæ ‡å‡†MIDIæ ¼å¼ï¼Œå®Œå…¨åœ¨æµè§ˆå™¨ä¸­è¿è¡Œï¼Œä¿æŠ¤éšç§</p>
        </header>

        <div class="main-content">
            <!-- è¾“å…¥åŒºåŸŸ -->
            <div class="card">
                <h2><i class="fas fa-upload"></i> è¾“å…¥æº</h2>
                
                <div class="tab-container">
                    <div class="tabs">
                        <button class="tab active" data-tab="url-tab">URLä¸‹è½½</button>
                        <button class="tab" data-tab="file-tab">æœ¬åœ°æ–‡ä»¶</button>
                    </div>
                    
                    <div class="tab-content active" id="url-tab">
                        <div class="input-group">
                            <label for="url-input">CCMZæ–‡ä»¶URLåœ°å€</label>
                            <input type="text" id="url-input" placeholder="è¯·è¾“å…¥CCMZæ–‡ä»¶çš„URLåœ°å€...">
                        </div>
                        
                        <div class="input-group">
                            <label for="output-name">è¾“å‡ºMIDIæ–‡ä»¶å</label>
                            <input type="text" id="output-name" value="output.mid" placeholder="è¾“å‡ºæ–‡ä»¶å...">
                        </div>
                        
                        <button class="button success" id="download-convert-btn">
                            <span class="btn-text">ä¸‹è½½å¹¶è½¬æ¢</span>
                            <span class="spinner" style="display: none;"></span>
                        </button>
                    </div>
                    
                    <div class="tab-content" id="file-tab">
                        <div class="file-input-container">
                            <input type="file" id="file-input" accept=".ccmz">
                            <label for="file-input" class="file-input-label" id="file-input-label">
                                <i class="fas fa-file-upload"></i>
                                <span>ç‚¹å‡»é€‰æ‹©æˆ–æ‹–æ‹½CCMZæ–‡ä»¶</span>
                                <div style="margin-top: var(--space-xs); font-size: var(--font-size-xs);">æ”¯æŒ.ccmzæ ¼å¼æ–‡ä»¶</div>
                            </label>
                        </div>
                        
                        <div class="input-group">
                            <label for="local-output-name">è¾“å‡ºMIDIæ–‡ä»¶å</label>
                            <input type="text" id="local-output-name" value="converted.mid" placeholder="è¾“å‡ºæ–‡ä»¶å...">
                        </div>
                        
                        <button class="button success" id="local-convert-btn">
                            <span class="btn-text">è½¬æ¢æœ¬åœ°æ–‡ä»¶</span>
                            <span class="spinner" style="display: none;"></span>
                        </button>
                    </div>
                </div>

                <div class="progress-container" id="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill"></div>
                    </div>
                    <div class="progress-text" id="progress-text">å‡†å¤‡ä¸­...</div>
                </div>
            </div>

            <!-- è¾“å‡ºåŒºåŸŸ -->
            <div class="card">
                <h2><i class="fas fa-download"></i> è¾“å‡ºç»“æœ</h2>
                
                <div id="status-box" class="status-box">
                    <h3><i class="fas fa-info-circle"></i> å¤„ç†çŠ¶æ€</h3>
                    <div class="status-content" id="status-content">
                        <!-- æ—¥å¿—å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                    </div>
                </div>
                
                <div id="download-section" style="display: none; margin-top: var(--space-lg);">
                    <a href="#" class="download-link" id="download-link" download>
                        <i class="fas fa-download"></i> ä¸‹è½½MIDIæ–‡ä»¶
                    </a>
                </div>
                
                <div class="tool-buttons">
                    <button class="button secondary" id="clear-log-btn">
                        <i class="fas fa-trash-alt"></i> æ¸…é™¤æ—¥å¿—
                    </button>
                    <button class="button secondary" id="copy-log-btn">
                        <i class="fas fa-copy"></i> å¤åˆ¶æ—¥å¿—
                    </button>
                </div>
            </div>
        </div>

        <footer>
            <p>Â© 2025 CCMZ è½¬ MIDI å·¥å…· | å®Œå…¨åœ¨æµè§ˆå™¨ä¸­è¿è¡Œï¼Œæ— éœ€æœåŠ¡å™¨</p>
            <p style="margin-top: var(--space-sm); font-size: var(--font-size-xs);">
                æ³¨æ„ï¼šæ‰€æœ‰æ–‡ä»¶å¤„ç†å‡åœ¨æœ¬åœ°æµè§ˆå™¨ä¸­è¿›è¡Œï¼Œä¸ä¼šä¸Šä¼ åˆ°ä»»ä½•æœåŠ¡å™¨
            </p>
        </footer>
    </div>

    <script>
        // è‡ªåŠ¨å¡«å……URLå‚æ•°
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const ccmzUrl = urlParams.get('ccmz');
            if (ccmzUrl) {
                document.querySelector("#url-input").value = ccmzUrl;
            }
        });
        
        // URLå¤„ç†å·¥å…·å‡½æ•°
        const URLUtils = {
            // ç®€åŒ–URLæ˜¾ç¤º - åªåœ¨æ—¥å¿—ä¸­æ˜¾ç¤ºç®€çŸ­ä¿¡æ¯
            formatForLog: function(url) {
                try {
                    // æå–æ–‡ä»¶å
                    const urlObj = new URL(url);
                    const pathname = urlObj.pathname;
                    const lastSlashIndex = pathname.lastIndexOf('/');
                    if (lastSlashIndex !== -1 && lastSlashIndex < pathname.length - 1) {
                        const filename = pathname.substring(lastSlashIndex + 1);
                        const hostname = urlObj.hostname.replace('www.', '');
                        return `${hostname}/.../${filename}`;
                    }
                } catch (e) {
                    // å¦‚æœURLæ— æ•ˆï¼Œå°è¯•ç›´æ¥æå–
                    const lastSlashIndex = url.lastIndexOf('/');
                    if (lastSlashIndex !== -1 && lastSlashIndex < url.length - 1) {
                        const filename = url.substring(lastSlashIndex + 1);
                        const domain = url.substring(0, Math.min(lastSlashIndex, 20));
                        return `${domain}/.../${filename}`;
                    }
                }
                // å¦‚æœæ— æ³•è§£æï¼Œæ˜¾ç¤ºå‰30ä¸ªå­—ç¬¦
                return url.length > 30 ? url.substring(0, 30) + '...' : url;
            }
        };
        
        // æ ¸å¿ƒè½¬æ¢é€»è¾‘
        class CCMZConverter {
            constructor() {
                this.statusLog = [];
                this.currentFile = null;
            }
            
            log(message, type = 'info') {
                const timestamp = new Date().toLocaleTimeString();
                
                // å¤„ç†åŒ…å«URLçš„æ¶ˆæ¯ - ç®€åŒ–æ˜¾ç¤º
                let displayMessage = message;
                
                // æ£€æŸ¥æ¶ˆæ¯ä¸­æ˜¯å¦åŒ…å«URL
                const urlRegex = /https?:\/\/[^\s]+/g;
                const urls = message.match(urlRegex);
                
                if (urls && urls.length > 0) {
                    // æ‰¾åˆ°ç¬¬ä¸€ä¸ªURLå¹¶ç®€åŒ–
                    const fullURL = urls[0];
                    const shortURL = URLUtils.formatForLog(fullURL);
                    
                    // æ›¿æ¢ä¸ºç®€åŒ–ç‰ˆæœ¬
                    displayMessage = message.replace(fullURL, shortURL);
                }
                
                // è¿‡æ»¤æ‰ä¸éœ€è¦æ˜¾ç¤ºçš„æ—¥å¿—
                const filteredMessages = [
                    'ä½¿ç”¨ç‰ˆæœ¬2è§£å¯†ï¼ˆå¥‡å¶è½¬æ¢ï¼‰...',
                    'æ‰¾åˆ°éŸ³ä¹æ•°æ®æ–‡ä»¶',
                    'ğŸ“¦ æ‰¾åˆ°',
                    'ğŸ¯ æ‰¾åˆ°éŸ³ä¹æ•°æ®æ–‡ä»¶'
                ];
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯éœ€è¦è¿‡æ»¤çš„æ—¥å¿—
                let shouldLog = true;
                for (const filteredMsg of filteredMessages) {
                    if (displayMessage.includes(filteredMsg)) {
                        shouldLog = false;
                        break;
                    }
                }
                
                if (!shouldLog) {
                    return; // ä¸è®°å½•è¿™æ¡æ—¥å¿—
                }
                
                const logEntry = {
                    time: timestamp,
                    message: message,
                    displayMessage: displayMessage,
                    type: type
                };
                
                this.statusLog.push(logEntry);
                this.updateStatusDisplay();
                
                console.log(`[${timestamp}] ${message}`);
            }
            
            updateStatusDisplay() {
                const statusContent = document.getElementById('status-content');
                if (!statusContent) return;
                
                let html = '';
                const recentLogs = this.statusLog.slice(-30); // æ¡Œé¢ç«¯æ˜¾ç¤ºæ›´å¤šæ—¥å¿—
                
                for (const entry of recentLogs) {
                    const displayMsg = entry.displayMessage || entry.message;
                    html += `<div class="log-entry log-${entry.type}">[${entry.time}] ${displayMsg}</div>`;
                }
                
                statusContent.innerHTML = html;
                statusContent.scrollTop = statusContent.scrollHeight;
                
                // æ˜¾ç¤ºçŠ¶æ€æ¡†
                document.getElementById('status-box').style.display = 'block';
            }
            
            updateProgress(percentage, message) {
                const progressFill = document.getElementById('progress-fill');
                const progressText = document.getElementById('progress-text');
                const progressContainer = document.getElementById('progress-container');
                
                if (progressFill) progressFill.style.width = `${percentage}%`;
                if (progressText) progressText.textContent = message;
                if (progressContainer) progressContainer.style.display = 'block';
            }
            
            async downloadCCMZ(url) {
                // åœ¨æ—¥å¿—ä¸­ç®€åŒ–URLæ˜¾ç¤º
                const shortURL = URLUtils.formatForLog(url);
                this.log(`æ­£åœ¨ä» ${shortURL} ä¸‹è½½ CCMZ æ–‡ä»¶...`, 'info');
                this.updateProgress(10, 'å¼€å§‹ä¸‹è½½æ–‡ä»¶...');
                
                try {
                    // æ·»åŠ æ—¶é—´æˆ³é˜²æ­¢ç¼“å­˜
                    const cacheBusterUrl = url + (url.includes('?') ? '&' : '?') + '_=' + Date.now();
                    
                    const response = await fetch(cacheBusterUrl, {
                        headers: {
                            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
                            'Accept': 'application/octet-stream'
                        },
                        mode: 'cors'
                    });
                    
                    if (!response.ok) {
                        throw new Error(`ä¸‹è½½å¤±è´¥ï¼ŒHTTP çŠ¶æ€ç : ${response.status}`);
                    }
                    
                    const data = await response.arrayBuffer();
                    this.updateProgress(30, 'æ–‡ä»¶ä¸‹è½½å®Œæˆ');
                    this.log(`âœ… ä¸‹è½½å®Œæˆ: ${data.byteLength.toLocaleString()} å­—èŠ‚`, 'success');
                    
                    return new Uint8Array(data);
                } catch (error) {
                    this.log(`âŒ ä¸‹è½½å¤±è´¥: ${error.message}`, 'error');
                    throw error;
                }
            }
            
            extractCCMZ(ccmzData) {
                this.log('ğŸ” æ­£åœ¨æå– CCMZ æ–‡ä»¶...', 'info');
                this.updateProgress(40, 'è§£å¯†CCMZæ–‡ä»¶...');
                
                try {
                    // ç¬¬ä¸€ä¸ªå­—èŠ‚æ˜¯ç‰ˆæœ¬å·
                    const version = ccmzData[0];
                    this.log(`ğŸ“Š CCMZ ç‰ˆæœ¬: ${version}`, 'info');
                    
                    // å‰©ä½™æ•°æ®
                    const remaining = ccmzData.slice(1);
                    
                    let decrypted;
                    if (version === 1) {
                        // ç‰ˆæœ¬1: ç›´æ¥å°±æ˜¯ZIP
                        this.log('ğŸ”“ ä½¿ç”¨ç‰ˆæœ¬1è§£å¯†ï¼ˆç›´æ¥ZIPï¼‰', 'info');
                        decrypted = remaining;
                    } else if (version === 2) {
                        // ç‰ˆæœ¬2: æ¯ä¸ªå­—èŠ‚å¥‡å¶æ€§è½¬æ¢
                        // ç§»é™¤è¯¦ç»†æ—¥å¿—ï¼Œåªè®°å½•è§£å¯†å®Œæˆ
                        this.log('ğŸ”“ è§£å¯†CCMZæ–‡ä»¶...', 'info');
                        decrypted = new Uint8Array(remaining.length);
                        
                        for (let i = 0; i < remaining.length; i++) {
                            const byte = remaining[i];
                            if (byte % 2 === 0) { // å¶æ•°
                                decrypted[i] = byte + 1;
                            } else { // å¥‡æ•°
                                decrypted[i] = byte - 1;
                            }
                        }
                        
                        this.log('âœ… è§£å¯†å®Œæˆ', 'success');
                    } else {
                        throw new Error(`âŒ ä¸æ”¯æŒçš„ CCMZ ç‰ˆæœ¬: ${version}`);
                    }
                    
                    this.updateProgress(60, 'è§£å‹ZIPæ–‡ä»¶...');
                    
                    // è§£å‹ZIPæ–‡ä»¶
                    return this.extractZip(decrypted);
                } catch (error) {
                    this.log(`âŒ æå–å¤±è´¥: ${error.message}`, 'error');
                    throw error;
                }
            }
            
            async extractZip(zipData) {
                try {
                    // ä½¿ç”¨JSZipåº“è§£å‹
                    if (typeof JSZip === 'undefined') {
                        throw new Error('JSZipåº“æœªåŠ è½½ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                    }
                    
                    const zip = await JSZip.loadAsync(zipData);
                    const files = Object.keys(zip.files);
                    
                    // ç§»é™¤æ–‡ä»¶æ•°é‡æ—¥å¿—
                    // this.log(`ğŸ“¦ æ‰¾åˆ° ${files.length} ä¸ªæ–‡ä»¶`, 'info');
                    
                    let jsonData = null;
                    
                    for (const filename of files) {
                        const file = zip.files[filename];
                        
                        // è·³è¿‡ç›®å½•
                        if (file.dir) {
                            continue;
                        }
                        
                        // æŸ¥æ‰¾ midi.json æ–‡ä»¶
                        if (filename.toLowerCase() === 'midi.json') {
                            try {
                                jsonData = await file.async('text');
                                // ç§»é™¤æ‰¾åˆ°æ–‡ä»¶æ—¥å¿—
                                // this.log(`ğŸ¯ æ‰¾åˆ°éŸ³ä¹æ•°æ®æ–‡ä»¶`, 'success');
                                break;
                            } catch (e) {
                                this.log(`âŒ è¯»å–æ–‡ä»¶å¤±è´¥: ${e.message}`, 'error');
                            }
                        }
                    }
                    
                    if (!jsonData) {
                        throw new Error('âŒ æœªæ‰¾åˆ°éŸ³ä¹æ•°æ®');
                    }
                    
                    this.updateProgress(80, 'è§£ææ•°æ®...');
                    const parsedJson = JSON.parse(jsonData);
                    this.log('âœ… æ•°æ®è§£æå®Œæˆ', 'success');
                    
                    return parsedJson;
                } catch (error) {
                    this.log(`âŒ è§£å‹å¤±è´¥: ${error.message}`, 'error');
                    throw error;
                }
            }
            
            jsonToMidi(jsonData) {
                this.log('ğŸ”„ å¼€å§‹è½¬æ¢åˆ° MIDI...', 'info');
                this.updateProgress(90, 'ç”ŸæˆMIDIæ–‡ä»¶...');
                
                try {
                    // æå–åŸºæœ¬ä¿¡æ¯
                    const ticksPerBeat = jsonData.division || 480;
                    const events = jsonData.events || [];
                    const tracks = jsonData.tracks || [];
                    
                    // éªŒè¯ PPQ æœ‰æ•ˆæ€§
                    const validTicksPerBeat = typeof ticksPerBeat === 'number' && ticksPerBeat > 0 ? ticksPerBeat : 480;
                    
                    // ç®€åŒ–çš„ç»Ÿè®¡ä¿¡æ¯
                    const trackCount = tracks.length || 1;
                    this.log(`è½¨é“æ•°é‡: ${trackCount}`, 'info');
                    
                    // åˆ›å»ºMIDIæ•°æ®
                    const midiData = this.generateMidiWithMultipleTracks(jsonData, validTicksPerBeat);
                    
                    this.log(`âœ… è½¬æ¢å®Œæˆ`, 'success');
                    this.updateProgress(100, 'è½¬æ¢å®Œæˆï¼');
                    
                    return midiData;
                } catch (error) {
                    this.log(`âŒ MIDIè½¬æ¢å¤±è´¥: ${error.message}`, 'error');
                    throw error;
                }
            }
            
            generateMidiWithMultipleTracks(jsonData, ticksPerBeat) {
                // åˆ›å»ºå¤šè½¨é“MIDIæ–‡ä»¶
                const tracks = jsonData.tracks || [];
                const events = jsonData.events || [];
                
                // MIDIæ ¼å¼ï¼šå¦‚æœè½¨é“æ•°>1åˆ™ç”¨æ ¼å¼1ï¼Œå¦åˆ™ç”¨æ ¼å¼0
                const midiFormat = tracks.length > 1 ? 1 : 0;
                const trackCount = midiFormat === 0 ? 1 : tracks.length + 1; // æ ¼å¼1éœ€è¦é¢å¤–çš„å…ƒæ•°æ®è½¨é“
                
                // åˆ›å»ºæ–‡ä»¶å¤´
                const header = this.createMidiHeader(midiFormat, trackCount, ticksPerBeat);
                
                // æ”¶é›†æ‰€æœ‰è½¨é“æ•°æ®
                const trackChunks = [];
                
                if (midiFormat === 1) {
                    // æ ¼å¼1ï¼šç¬¬ä¸€ä¸ªè½¨é“æ˜¯å…ƒæ•°æ®è½¨é“
                    const metaTrack = this.createMetaTrack(jsonData, ticksPerBeat);
                    trackChunks.push(metaTrack);
                    
                    // ä¸ºæ¯ä¸ªéŸ³ä¹è½¨é“åˆ›å»ºè½¨é“
                    for (let i = 0; i < tracks.length; i++) {
                        const musicTrack = this.createMusicTrack(jsonData, ticksPerBeat, i);
                        trackChunks.push(musicTrack);
                    }
                } else {
                    // æ ¼å¼0ï¼šåªæœ‰ä¸€ä¸ªè½¨é“ï¼ŒåŒ…å«æ‰€æœ‰å†…å®¹
                    const singleTrack = this.createSingleTrack(jsonData, ticksPerBeat);
                    trackChunks.push(singleTrack);
                }
                
                // è®¡ç®—æ€»å¤§å°
                let totalSize = header.length;
                for (const chunk of trackChunks) {
                    totalSize += chunk.length;
                }
                
                // åˆå¹¶æ‰€æœ‰æ•°æ®
                const midiData = new Uint8Array(totalSize);
                let offset = 0;
                
                midiData.set(header, offset);
                offset += header.length;
                
                for (const chunk of trackChunks) {
                    midiData.set(chunk, offset);
                    offset += chunk.length;
                }
                
                return midiData;
            }
            
            createMidiHeader(format, trackCount, ticksPerBeat) {
                const buffer = new ArrayBuffer(14);
                const view = new DataView(buffer);
                
                // MIDIæ–‡ä»¶å¤´æ ‡è¯† "MThd"
                view.setUint8(0, 0x4D); // M
                view.setUint8(1, 0x54); // T
                view.setUint8(2, 0x68); // h
                view.setUint8(3, 0x64); // d
                
                // å¤´éƒ¨é•¿åº¦ (6å­—èŠ‚)
                view.setUint32(4, 6, false);
                
                // æ ¼å¼ç±»å‹ (0: å•è½¨é“, 1: å¤šè½¨é“åŒæ­¥)
                view.setUint16(8, format, false);
                
                // è½¨é“æ•°é‡
                view.setUint16(10, trackCount, false);
                
                // æ—¶é—´ç²¾åº¦ (ticks per beat)
                view.setUint16(12, ticksPerBeat, false);
                
                return new Uint8Array(buffer);
            }
            
            createMetaTrack(jsonData, ticksPerBeat) {
                const events = [];
                
                // æ·»åŠ é€Ÿåº¦äº‹ä»¶
                const tempos = jsonData.tempos || [];
                if (tempos.length === 0) {
                    // é»˜è®¤é€Ÿåº¦ (120 BPM = 500000å¾®ç§’/å››åˆ†éŸ³ç¬¦)
                    events.push({
                        deltaTime: 0,
                        type: 'tempo',
                        value: 500000
                    });
                } else {
                    let lastTick = 0;
                    for (const tempo of tempos) {
                        const tick = tempo.tick || 0;
                        const tempoValue = tempo.tempo || 500000;
                        events.push({
                            deltaTime: tick - lastTick,
                            type: 'tempo',
                            value: tempoValue
                        });
                        lastTick = tick;
                    }
                }
                
                // æ·»åŠ æ‹å·äº‹ä»¶
                const beatInfos = jsonData.beatInfos || [];
                if (beatInfos.length === 0) {
                    // é»˜è®¤æ‹å· 4/4
                    events.push({
                        deltaTime: 0,
                        type: 'timeSignature',
                        numerator: 4,
                        denominator: 4
                    });
                } else {
                    let lastTick = 0;
                    for (const beat of beatInfos) {
                        const tick = beat.tick || 0;
                        const numerator = beat.beats || 4;
                        const denominator = beat.beatsUnit || 4;
                        events.push({
                            deltaTime: tick - lastTick,
                            type: 'timeSignature',
                            numerator: numerator,
                            denominator: denominator
                        });
                        lastTick = tick;
                    }
                }
                
                // æ·»åŠ è½¨é“ç»“æŸäº‹ä»¶
                events.push({
                    deltaTime: 0,
                    type: 'endOfTrack'
                });
                
                // ç¼–ç è½¨é“æ•°æ®
                return this.encodeTrackChunk(events);
            }
            
            createMusicTrack(jsonData, ticksPerBeat, trackIndex) {
                const events = [];
                const allEvents = jsonData.events || [];
                const tracks = jsonData.tracks || [];
                
                // è·å–å½“å‰è½¨é“çš„é…ç½®
                const trackConfig = tracks[trackIndex] || {};
                const channel = trackConfig.channel || trackIndex;
                const program = trackConfig.program || 0;
                
                // æ·»åŠ éŸ³è‰²å˜æ›´äº‹ä»¶
                if (program >= 0) {
                    events.push({
                        deltaTime: 0,
                        type: 'programChange',
                        channel: channel % 16, // MIDIé€šé“0-15
                        program: program
                    });
                }
                
                // è¿‡æ»¤å‡ºå½“å‰è½¨é“çš„äº‹ä»¶
                const trackEvents = allEvents.filter(event => {
                    const eventTrack = event.track || 0;
                    return eventTrack === trackIndex;
                });
                
                // æŒ‰tickæ’åº
                trackEvents.sort((a, b) => (a.tick || 0) - (b.tick || 0));
                
                // å¤„ç†äº‹ä»¶
                let lastTick = 0;
                
                for (const event of trackEvents) {
                    const tick = event.tick || 0;
                    const delta = tick - lastTick;
                    const eventData = event.event || [];
                    
                    if (eventData.length >= 3) {
                        const status = eventData[0];
                        const msgType = status & 0xF0;
                        const eventChannel = status & 0x0F;
                        
                        // ä½¿ç”¨é…ç½®çš„é€šé“ï¼Œä½†äº‹ä»¶ä¸­å¯èƒ½æŒ‡å®šäº†é€šé“
                        const finalChannel = eventChannel !== 0 ? eventChannel : channel % 16;
                        
                        if (msgType === 0x90 || msgType === 0x80) {
                            // Note On æˆ– Note Off
                            const note = eventData[1];
                            const velocity = eventData[2];
                            
                            if (msgType === 0x90 && velocity > 0) {
                                // Note On
                                events.push({
                                    deltaTime: delta,
                                    type: 'noteOn',
                                    channel: finalChannel,
                                    note: note,
                                    velocity: velocity
                                });
                            } else {
                                // Note Off æˆ– velocity=0çš„Note On
                                events.push({
                                    deltaTime: delta,
                                    type: 'noteOff',
                                    channel: finalChannel,
                                    note: note,
                                    velocity: 0
                                });
                            }
                            
                            lastTick = tick;
                        }
                    }
                }
                
                // æ·»åŠ è½¨é“ç»“æŸäº‹ä»¶
                events.push({
                    deltaTime: 0,
                    type: 'endOfTrack'
                });
                
                // ç¼–ç è½¨é“æ•°æ®
                return this.encodeTrackChunk(events);
            }
            
            createSingleTrack(jsonData, ticksPerBeat) {
                const events = [];
                
                // æ·»åŠ é€Ÿåº¦äº‹ä»¶
                const tempos = jsonData.tempos || [];
                if (tempos.length === 0) {
                    // é»˜è®¤é€Ÿåº¦ (120 BPM = 500000å¾®ç§’/å››åˆ†éŸ³ç¬¦)
                    events.push({
                        deltaTime: 0,
                        type: 'tempo',
                        value: 500000
                    });
                } else {
                    let lastTick = 0;
                    for (const tempo of tempos) {
                        const tick = tempo.tick || 0;
                        const tempoValue = tempo.tempo || 500000;
                        events.push({
                            deltaTime: tick - lastTick,
                            type: 'tempo',
                            value: tempoValue
                        });
                        lastTick = tick;
                    }
                }
                
                // æ·»åŠ æ‹å·äº‹ä»¶
                const beatInfos = jsonData.beatInfos || [];
                if (beatInfos.length === 0) {
                    // é»˜è®¤æ‹å· 4/4
                    events.push({
                        deltaTime: 0,
                        type: 'timeSignature',
                        numerator: 4,
                        denominator: 4
                    });
                } else {
                    let lastTick = 0;
                    for (const beat of beatInfos) {
                        const tick = beat.tick || 0;
                        const numerator = beat.beats || 4;
                        const denominator = beat.beatsUnit || 4;
                        events.push({
                            deltaTime: tick - lastTick,
                            type: 'timeSignature',
                            numerator: numerator,
                            denominator: denominator
                        });
                        lastTick = tick;
                    }
                }
                
                // æ·»åŠ éŸ³è‰²å˜æ›´äº‹ä»¶
                const tracks = jsonData.tracks || [];
                if (tracks.length > 0) {
                    const track = tracks[0];
                    if (track.program >= 0) {
                        events.push({
                            deltaTime: 0,
                            type: 'programChange',
                            channel: track.channel || 0,
                            program: track.program
                        });
                    }
                }
                
                // å¤„ç†æ‰€æœ‰äº‹ä»¶ï¼ˆä¸åˆ†è½¨é“ï¼‰
                const allEvents = jsonData.events || [];
                allEvents.sort((a, b) => (a.tick || 0) - (b.tick || 0));
                
                let lastTick = 0;
                
                for (const event of allEvents) {
                    const tick = event.tick || 0;
                    const delta = tick - lastTick;
                    const eventData = event.event || [];
                    
                    if (eventData.length >= 3) {
                        const status = eventData[0];
                        const msgType = status & 0xF0;
                        const channel = status & 0x0F;
                        
                        if (msgType === 0x90 || msgType === 0x80) {
                            // Note On æˆ– Note Off
                            const note = eventData[1];
                            const velocity = eventData[2];
                            
                            if (msgType === 0x90 && velocity > 0) {
                                // Note On
                                events.push({
                                    deltaTime: delta,
                                    type: 'noteOn',
                                    channel: channel,
                                    note: note,
                                    velocity: velocity
                                });
                            } else {
                                // Note Off æˆ– velocity=0çš„Note On
                                events.push({
                                    deltaTime: delta,
                                    type: 'noteOff',
                                    channel: channel,
                                    note: note,
                                    velocity: 0
                                });
                            }
                            
                            lastTick = tick;
                        }
                    }
                }
                
                // æ·»åŠ è½¨é“ç»“æŸäº‹ä»¶
                events.push({
                    deltaTime: 0,
                                    type: 'endOfTrack'
                });
                
                // ç¼–ç è½¨é“æ•°æ®
                return this.encodeTrackChunk(events);
            }
            
            encodeTrackChunk(events) {
                // é¦–å…ˆè®¡ç®—éœ€è¦çš„æ€»å¤§å°
                let trackDataSize = 0;
                
                for (const event of events) {
                    // delta timeçš„å¤§å°
                    trackDataSize += this.calculateVarIntSize(event.deltaTime || 0);
                    
                    // äº‹ä»¶æ•°æ®çš„å¤§å°
                    switch (event.type) {
                        case 'tempo':
                            trackDataSize += 6; // FF 51 03 + 3å­—èŠ‚tempo
                            break;
                        case 'timeSignature':
                            trackDataSize += 7; // FF 58 04 + 4å­—èŠ‚
                            break;
                        case 'programChange':
                            trackDataSize += 2; // Cx + program
                            break;
                        case 'noteOn':
                            trackDataSize += 3; // 9x + note + velocity
                            break;
                        case 'noteOff':
                            trackDataSize += 3; // 8x + note + velocity
                            break;
                        case 'endOfTrack':
                            trackDataSize += 3; // FF 2F 00
                            break;
                    }
                }
                
                // åˆ›å»ºè½¨é“å—ç¼“å†²åŒº (8å­—èŠ‚å¤´ + è½¨é“æ•°æ®)
                const buffer = new ArrayBuffer(8 + trackDataSize);
                const view = new DataView(buffer);
                let offset = 0;
                
                // å†™å…¥è½¨é“å¤´ "MTrk"
                view.setUint8(offset++, 0x4D); // M
                view.setUint8(offset++, 0x54); // T
                view.setUint8(offset++, 0x72); // r
                view.setUint8(offset++, 0x6B); // k
                
                // å†™å…¥è½¨é“é•¿åº¦
                view.setUint32(offset, trackDataSize, false);
                offset += 4;
                
                // å†™å…¥äº‹ä»¶
                for (const event of events) {
                    // å†™å…¥delta time
                    offset = this.writeVarInt(view, offset, event.deltaTime || 0);
                    
                    switch (event.type) {
                        case 'tempo':
                            view.setUint8(offset++, 0xFF);
                            view.setUint8(offset++, 0x51);
                            view.setUint8(offset++, 0x03);
                            const tempo = event.value || 500000;
                            view.setUint8(offset++, (tempo >> 16) & 0xFF);
                            view.setUint8(offset++, (tempo >> 8) & 0xFF);
                            view.setUint8(offset++, tempo & 0xFF);
                            break;
                            
                        case 'timeSignature':
                            view.setUint8(offset++, 0xFF);
                            view.setUint8(offset++, 0x58);
                            view.setUint8(offset++, 0x04);
                            view.setUint8(offset++, event.numerator || 4);
                            
                            // åˆ†æ¯æ˜¯2çš„å¹‚æ¬¡ï¼Œ4=2^2, 2=2^1, 8=2^3, 16=2^4
                            let denominatorPower = 2;
                            if (event.denominator === 2) denominatorPower = 1;
                            else if (event.denominator === 8) denominatorPower = 3;
                            else if (event.denominator === 16) denominatorPower = 4;
                            
                            view.setUint8(offset++, denominatorPower);
                            view.setUint8(offset++, 24); // MIDIæ—¶é’Ÿæ¯å››åˆ†éŸ³ç¬¦çš„æ»´ç­”æ•°
                            view.setUint8(offset++, 8);  // 32åˆ†éŸ³ç¬¦çš„æ•°é‡
                            break;
                            
                        case 'programChange':
                            view.setUint8(offset++, 0xC0 | (event.channel || 0));
                            view.setUint8(offset++, event.program || 0);
                            break;
                            
                        case 'noteOn':
                            view.setUint8(offset++, 0x90 | (event.channel || 0));
                            view.setUint8(offset++, event.note || 60);
                            view.setUint8(offset++, event.velocity || 64);
                            break;
                            
                        case 'noteOff':
                            view.setUint8(offset++, 0x80 | (event.channel || 0));
                            view.setUint8(offset++, event.note || 60);
                            view.setUint8(offset++, 0);
                            break;
                            
                        case 'endOfTrack':
                            view.setUint8(offset++, 0xFF);
                            view.setUint8(offset++, 0x2F);
                            view.setUint8(offset++, 0x00);
                            break;
                    }
                }
                
                return new Uint8Array(buffer);
            }
            
            calculateVarIntSize(value) {
                value = Math.floor(value);
                let size = 0;
                
                do {
                    value >>= 7;
                    size++;
                } while (value > 0);
                
                return size;
            }
            
            writeVarInt(view, offset, value) {
                value = Math.floor(value);
                const bytes = [];
                
                do {
                    let byte = value & 0x7F;
                    value >>= 7;
                    if (bytes.length > 0) byte |= 0x80;
                    bytes.push(byte);
                } while (value > 0);
                
                for (let i = bytes.length - 1; i >= 0; i--) {
                    view.setUint8(offset++, bytes[i]);
                }
                
                return offset;
            }
            
            async convertFromURL(url, outputFilename) {
                try {
                    this.resetState();
                    this.log('å¼€å§‹ä»URLè½¬æ¢CCMZæ–‡ä»¶...', 'info');
                    
                    // ä¸‹è½½CCMZæ–‡ä»¶
                    const ccmzData = await this.downloadCCMZ(url);
                    
                    // æå–å’Œè½¬æ¢
                    const jsonData = await this.extractCCMZ(ccmzData);
                    const midiData = this.jsonToMidi(jsonData);
                    
                    // ä¿å­˜æ–‡ä»¶
                    this.saveMidiFile(midiData, outputFilename);
                    
                    return true;
                } catch (error) {
                    this.log(`è½¬æ¢å¤±è´¥: ${error.message}`, 'error');
                    return false;
                }
            }
            
            async convertFromFile(file, outputFilename) {
                try {
                    this.resetState();
                    this.log(`å¼€å§‹è½¬æ¢æœ¬åœ°æ–‡ä»¶: ${file.name}`, 'info');
                    
                    // è¯»å–æ–‡ä»¶
                    const arrayBuffer = await file.arrayBuffer();
                    const ccmzData = new Uint8Array(arrayBuffer);
                    
                    this.updateProgress(20, 'æ–‡ä»¶è¯»å–å®Œæˆ');
                    
                    // æå–å’Œè½¬æ¢
                    const jsonData = await this.extractCCMZ(ccmzData);
                    const midiData = this.jsonToMidi(jsonData);
                    
                    // ä¿å­˜æ–‡ä»¶
                    this.saveMidiFile(midiData, outputFilename);
                    
                    return true;
                } catch (error) {
                    this.log(`è½¬æ¢å¤±è´¥: ${error.message}`, 'error');
                    return false;
                }
            }
            
            saveMidiFile(midiData, filename) {
                // åˆ›å»ºBlobå¹¶ä¸‹è½½
                const blob = new Blob([midiData], { type: 'audio/midi' });
                const url = URL.createObjectURL(blob);
                
                // æ›´æ–°ä¸‹è½½é“¾æ¥
                const downloadLink = document.getElementById('download-link');
                downloadLink.href = url;
                downloadLink.download = filename;
                
                // æ˜¾ç¤ºä¸‹è½½é“¾æ¥
                document.getElementById('download-section').style.display = 'block';
                
                this.log(`âœ… MIDIæ–‡ä»¶å·²ç”Ÿæˆ: ${filename}`, 'success');
                this.log(`æ–‡ä»¶å¤§å°: ${midiData.length.toLocaleString()} å­—èŠ‚`, 'info');
            }
            
            resetState() {
                this.statusLog = [];
                this.updateProgress(0, 'å‡†å¤‡ä¸­...');
                
                // éšè—ä¹‹å‰çš„ä¸‹è½½é“¾æ¥
                document.getElementById('download-section').style.display = 'none';
            }
        }

        // åˆå§‹åŒ–åº”ç”¨
        document.addEventListener('DOMContentLoaded', function() {
            const converter = new CCMZConverter();
            
            // æ ‡ç­¾åˆ‡æ¢åŠŸèƒ½
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    
                    // ç§»é™¤æ‰€æœ‰activeç±»
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    // æ·»åŠ activeç±»
                    this.classList.add('active');
                    document.getElementById(tabId).classList.add('active');
                });
            });
            
            // æ–‡ä»¶æ‹–æ”¾åŠŸèƒ½
            const fileInput = document.getElementById('file-input');
            const fileInputLabel = document.getElementById('file-input-label');
            
            fileInput.addEventListener('change', function() {
                if (this.files.length > 0) {
                    const fileName = this.files[0].name;
                    fileInputLabel.innerHTML = `
                        <i class="fas fa-file-music" style="color: var(--primary);"></i>
                        <span>å·²é€‰æ‹©æ–‡ä»¶: ${fileName}</span>
                        <div style="margin-top: var(--space-xs); font-size: var(--font-size-xs);">ç‚¹å‡»é‡æ–°é€‰æ‹©</div>
                    `;
                    fileInputLabel.classList.add('file-selected');
                }
            });
            
            // æ‹–æ”¾äº‹ä»¶
            fileInputLabel.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.style.borderColor = 'var(--primary)';
                this.style.backgroundColor = 'var(--primary-container)';
            });
            
            fileInputLabel.addEventListener('dragleave', function(e) {
                e.preventDefault();
                this.style.borderColor = 'var(--outline)';
                this.style.backgroundColor = '';
            });
            
            fileInputLabel.addEventListener('drop', function(e) {
                e.preventDefault();
                this.style.borderColor = 'var(--outline)';
                this.style.backgroundColor = '';
                
                if (e.dataTransfer.files.length > 0) {
                    const file = e.dataTransfer.files[0];
                    if (file.name.toLowerCase().endsWith('.ccmz')) {
                        // åˆ›å»ºDataTransferå¯¹è±¡æ¥è®¾ç½®æ–‡ä»¶
                        const dataTransfer = new DataTransfer();
                        dataTransfer.items.add(file);
                        fileInput.files = dataTransfer.files;
                        
                        // è§¦å‘changeäº‹ä»¶
                        fileInput.dispatchEvent(new Event('change'));
                    } else {
                        alert('è¯·é€‰æ‹©.ccmzæ ¼å¼çš„æ–‡ä»¶');
                    }
                }
            });
            
            // ä»URLä¸‹è½½å¹¶è½¬æ¢
            document.getElementById('download-convert-btn').addEventListener('click', async function() {
                const url = document.getElementById('url-input').value.trim();
                const outputName = document.getElementById('output-name').value.trim() || 'output.mid';
                
                if (!url) {
                    alert('è¯·è¾“å…¥CCMZæ–‡ä»¶çš„URLåœ°å€');
                    return;
                }
                
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                const btnText = this.querySelector('.btn-text');
                const spinner = this.querySelector('.spinner');
                btnText.textContent = 'è½¬æ¢ä¸­...';
                spinner.style.display = 'inline-block';
                this.disabled = true;
                
                try {
                    await converter.convertFromURL(url, outputName);
                } catch (error) {
                    console.error('è½¬æ¢é”™è¯¯:', error);
                } finally {
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    btnText.textContent = 'ä¸‹è½½å¹¶è½¬æ¢';
                    spinner.style.display = 'none';
                    this.disabled = false;
                }
            });
            
            // è½¬æ¢æœ¬åœ°æ–‡ä»¶
            document.getElementById('local-convert-btn').addEventListener('click', async function() {
                const file = fileInput.files[0];
                const outputName = document.getElementById('local-output-name').value.trim() || 'converted.mid';
                
                if (!file) {
                    alert('è¯·é€‰æ‹©CCMZæ–‡ä»¶');
                    return;
                }
                
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                const btnText = this.querySelector('.btn-text');
                const spinner = this.querySelector('.spinner');
                btnText.textContent = 'è½¬æ¢ä¸­...';
                spinner.style.display = 'inline-block';
                this.disabled = true;
                
                try {
                    await converter.convertFromFile(file, outputName);
                } catch (error) {
                    console.error('è½¬æ¢é”™è¯¯:', error);
                } finally {
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    btnText.textContent = 'è½¬æ¢æœ¬åœ°æ–‡ä»¶';
                    spinner.style.display = 'none';
                    this.disabled = false;
                }
            });
            
            // æ¸…é™¤æ—¥å¿—
            document.getElementById('clear-log-btn').addEventListener('click', function() {
                converter.statusLog = [];
                converter.updateStatusDisplay();
            });
            
            // å¤åˆ¶æ—¥å¿—
            document.getElementById('copy-log-btn').addEventListener('click', function() {
                const statusContent = document.getElementById('status-content');
                if (statusContent) {
                    // è·å–çº¯æ–‡æœ¬æ—¥å¿—
                    const logEntries = Array.from(statusContent.querySelectorAll('.log-entry'));
                    const logText = logEntries.map(entry => entry.textContent).join('\n');
                    
                    navigator.clipboard.writeText(logText)
                        .then(() => {
                            alert('æ—¥å¿—å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                        })
                        .catch(err => {
                            console.error('å¤åˆ¶å¤±è´¥:', err);
                            alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©å¹¶å¤åˆ¶');
                        });
                }
            });
            
            // åˆå§‹åŒ–æ—¥å¿—æ˜¾ç¤º
            converter.log('CCMZ åˆ° MIDI è½¬æ¢å·¥å…·å·²å°±ç»ª', 'info');
            converter.log('é€‰æ‹©è¾“å…¥æºå¼€å§‹è½¬æ¢', 'info');
        });
    </script>
    
    <!-- å¼•å…¥JSZipåº“ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</body>
</html>
